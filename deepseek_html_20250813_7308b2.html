<!DOCTYPE html>
<html>
<head>
    <title>Offline 2FA Authenticator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 20px auto; padding: 20px; }
        input, button { padding: 10px; width: 100%; margin: 10px 0; }
        #code { font-size: 24px; font-weight: bold; text-align: center; color: #0066cc; }
        #timer { text-align: center; }
    </style>
</head>
<body>
    <h1>Offline 2FA Authenticator</h1>
    <p>Enter your <strong>Base32 secret key</strong> (from manual setup):</p>
    <input type="text" id="secret" placeholder="e.g., JBSWY3DPEHPK3PXP" />
    <button onclick="startTOTP()">Generate Code</button>
    <div id="code">------</div>
    <div id="timer">Refreshes in: 30s</div>

    <script>
        function base32toHex(base32) {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
            let bits = "", hex = "";
            for (let i = 0; i < base32.length; i++) {
                const val = chars.indexOf(base32[i].toUpperCase());
                if (val === -1) continue;
                bits += val.toString(2).padStart(5, '0');
            }
            for (let i = 0; i + 4 <= bits.length; i += 4) {
                const chunk = bits.substr(i, 4);
                hex += parseInt(chunk, 2).toString(16);
            }
            return hex;
        }

        function generateTOTP(secret) {
            const epoch = Math.floor(Date.now() / 1000);
            const time = Math.floor(epoch / 30);
            const hexTime = time.toString(16).padStart(16, '0');
            const hexSecret = base32toHex(secret);

            const hmac = CryptoJS.HmacSHA1(CryptoJS.enc.Hex.parse(hexTime), CryptoJS.enc.Hex.parse(hexSecret));
            const hmacHex = hmac.toString(CryptoJS.enc.Hex);

            const offset = parseInt(hmacHex.substr(hmacHex.length - 1), 16) * 2;
            const otp = (parseInt(hmacHex.substr(offset, 8), 16) & 0x7fffffff) + '';
            return otp.substr(otp.length - 6);
        }

        function startTOTP() {
            const secret = document.getElementById('secret').value.trim();
            if (!secret) return alert("Enter a secret key!");

            updateCode(secret);
            setInterval(() => updateCode(secret), 1000);
        }

        function updateCode(secret) {
            const code = generateTOTP(secret);
            const timeLeft = 30 - Math.floor(Date.now() / 1000 % 30);

            document.getElementById('code').textContent = code.match(/.{1,3}/g).join(' ');
            document.getElementById('timer').textContent = `Refreshes in: ${timeLeft}s`;
        }
    </script>
</body>
</html>